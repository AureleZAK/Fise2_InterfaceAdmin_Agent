image: python:3.10.12


before_script:
  - echo "Dependencies installation"
  - python3 --version
  - pip3 --version
  - pip3 install -r requirements.txt
  

stages:
  - compile
  - lint
  - test
  - code coverage

compile:
  stage: compile
  script:
    - echo "Compiling code"
    - find src/ -type f -name '*.py' -exec python3 -m py_compile {} + 

lint:
  stage: lint
  script:
    - echo "Checking code quality"
    - find src/ -type f -name '*.py' -exec python3 -m pylint {} + || true
    - output=$(find src/ -type f -name '*.py' -exec python3 -m pylint {} + || true --score=y)
    - score=$(echo "$output" | grep -oP "(?<=rated at ).*?(?=/)")
    - anybadge -l Pylint -v $score -f badge.svg -c green yellow orange red

test:
  stage: test
  script:
    - echo "Running test"
    - python3 -m pytest src/tests/

code coverage:
  stage: code coverage
  script:
    - echo "Running code coverage"
    - rm coverage.svg
    - coverage run --source=src/ -m pytest
    - coverage report -m
    - anybadge --value=$(coverage report -m | grep "TOTAL" | awk '{print $4}') --file=coverage.svg --label=coverage
