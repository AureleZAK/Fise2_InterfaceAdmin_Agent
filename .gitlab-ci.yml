image: python:3.10.12

#before_script:
  #- echo "Dependencies installation"
  #- python3 --version
  #- pip3 --version
  #- pip3 install -r requirements.txt

stages:
  #- compile
  #- lint
  #- test
  #- code coverage
  - build

#compile:
  #stage: compile
  #script:
    #- echo "Compiling code"
    #- find src/ -type f -name '*.py' -exec python3 -m py_compile {} +

#lint:
  #stage: lint
  #script:
    #- echo "Checking code quality"
    #- find src/ -type f -name '*.py' -exec python3 -m pylint --fail-under=9 {} +

#test:
  #stage: test
  #script:
    #- echo "Running test"
    #- python3 -m pytest src/tests/

#code_coverage:
  #stage: code coverage
  #script:
    #- echo "Running code coverage"
    #- rm coverage.svg
    #- coverage run --source=src/ -m pytest
    #- coverage report -m
    #- anybadge --value=$(coverage report -m | grep "TOTAL" | awk '{print $4}') --file=coverage.svg --label=coverage

build:
  stage: build
  image: ubuntu:20.04  # Choisissez la version d'Ubuntu appropriÃ©e
  services:
    - docker:dind
  script:
    - apt-get update -qy
    - DEBIAN_FRONTEND=noninteractive apt-get install -y python3 python3-pip
    - pip3 install -r requirements.txt
    - python3 -m py_compile src/*.py
    - DEBIAN_FRONTEND=noninteractive apt-get install -y apt-transport-https ca-certificates curl gnupg lsb-release
    - curl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg
    - echo "deb [arch=amd64 signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | tee /etc/apt/sources.list.d/docker.list > /dev/null
    - apt-get update -qy
    - DEBIAN_FRONTEND=noninteractive apt-get install -y docker-ce docker-ce-cli containerd.io
    - docker build -t image_agent .
    - docker login devops.telecomste.fr:5050
    - docker tag image_agent devops.telecomste.fr:5050/printerfaceadmin/2023-24/group4/agent
    - docker push devops.telecomste.fr:5050/printerfaceadmin/2023-24/group4/agent
